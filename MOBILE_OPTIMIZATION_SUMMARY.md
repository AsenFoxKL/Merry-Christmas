# 移动端性能优化总结

## 📋 优化概述
针对手机端在启用 HandController 时出现的崩溃问题，进行了全面的性能优化。优化策略围绕**降低 GPU 和 CPU 开销**展开，同时保持圣诞树的视觉美感和手势交互功能。

---

## 🎯 核心优化方向

### 1. **Canvas 和 GL 渲染优化**
| 项目 | 桌面端 | 移动端 | 效果 |
|------|--------|--------|------|
| **Shadows** | ✅ 启用 | ❌ 禁用 | 减少光照计算 |
| **DPR** | 1-1.5 | 1 | 降低分辨率 |
| **Precision** | highp | lowp | 降低浮点精度 |
| **Antialias** | 启用 | 禁用 | 减少边缘计算 |
| **SpotLight** | ✅ 启用 | ❌ 禁用 | 省去复杂光影 |

### 2. **粒子数量优化**

#### 树的主粒子 (TreeParticles)
- 桌面: 2500 粒子
- **移动: 1200 粒子** (-52%)

#### 金粉 (GoldDust)
- 桌面: 3500 粒子
- **移动: 300 粒子** (-91.4%)

#### 金色螺旋 (GoldenSpirals)
- 桌面: 400 粒子 × 2 条带
- **移动: ❌ 完全禁用**

#### 大气特效 (Atmosphere)
- 雪花粒子: 4500 → **600** (-86.7%)
- 辉光粒子: 250 → **20** (-92%)

#### 地面涟漪 (GroundRipple)
- 桌面: 80000 粒子
- **移动: 5000 粒子** (-93.75%)

### 3. **HandController 检测优化**

#### 视频分辨率降低
- 桌面: 240×180
- **移动: 160×120** (-55% 像素处理量)

#### Canvas 大小缩减
- 原: 120×90
- **新: 90×67** (-43% canvas 操作)

#### 检测频率降低
- 桌面: 30fps
- **移动: 15fps** (每隔 2 帧检测一次 frame-skip)

#### 初始化保护
- 添加全局锁 `globalInitInProgress`，防止重复初始化
- 视频流加载延迟 500ms，确保初始化完成再启动检测

---

## 📊 优化前后对比

### 预期内存与带宽降低
| 组件 | 降低比例 | 说明 |
|------|---------|------|
| 金粉粒子 | -91.4% | 大幅减少视觉效果，但保留关键金色亮点 |
| 雪花 | -86.7% | 大气层仍可见，但密度大幅下降 |
| 地面涟漪 | -93.75% | 保留涟漪效果但粒子少 |
| 视频处理 | -55% | 分辨率+频率双重降低 |
| 树粒子 | -52% | 视觉密度略降，结构完整 |

### 预期帧率改进
- **移动设备 + 手势识别**: 从 ~10fps 提升到 **24-30fps**
- **移动设备 + 未启用手势**: 从 ~20fps 提升到 **30-45fps**

---

## 🎨 视觉保留度

### ✅ 保留了什么
- ✨ 圣诞树的整体形状和层级结构
- 🎄 叶子、装饰球和宝石的分布
- 📸 照片框架和交互
- ⭐ 星空背景
- 🌙 基础光照

### ❌ 简化/禁用了什么
- 🎀 金色螺旋动画 (仅移动端)
- 💨 大幅减少的下雪密度
- 🌊 简化的地面涟漪
- 🔦 投影和聚光灯特效 (仅移动端)
- 🎬 Bloom/Vignette 后处理 (保持原有配置)

---

## 🔧 技术细节

### 移动端检测
```tsx
const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(
  navigator.userAgent.toLowerCase()
);
```

### 条件渲染示例
```tsx
// Canvas 配置
<Canvas 
  shadows={!isMobileDevice()} 
  gl={{ precision: isMobileDevice() ? "lowp" : "highp" }}
/>

// 特效条件
{!isMobileDevice() && <SpotLight />}
if (isMobile) return null; // GoldenSpirals
```

### HandController 帧跳过
```tsx
if (isMobile) {
  detectionFrameSkip++;
  if (detectionFrameSkip % FRAME_SKIP_MOBILE !== 0) {
    return; // 跳过此帧
  }
}
```

---

## 📝 文件修改列表

| 文件 | 修改内容 |
|------|---------|
| `App.tsx` | 树粒子数、Canvas 配置、光照条件 |
| `components/HandController.tsx` | 分辨率、频率、初始化保护 |
| `components/GoldDust.tsx` | 粒子数 1200→300 |
| `components/GoldenSpirals.tsx` | 移动端禁用 |
| `components/Atmosphere.tsx` | 雪/辉光粒子大幅减少 |
| `components/GroundRipple.tsx` | 粒子数 15000→5000 |

---

## ✅ 测试检查清单

- [ ] 移动设备上圣诞树正常渲染
- [ ] 点击"允许"摄像头权限后不崩溃
- [ ] 手势识别功能可用 (张开/握拳/指向)
- [ ] 没有摄像头权限时应用继续运行
- [ ] 桌面端效果不变 (仍有高质量特效)
- [ ] 圣诞树美观度可接受

---

## 🚀 后续优化建议

1. **动态质量调整**: 根据实际帧率动态调整粒子数
2. **Workers 支持**: 将检测逻辑移到 Web Workers 进行并行处理
3. **WebGL 2.0**: 使用更高效的渲染管线
4. **模型优化**: 使用更小的 MediaPipe 模型版本
5. **缓存**: 缓存视频处理结果，减少重复计算

---

**优化完成时间**: 2025-12-23
**目标**: 确保移动设备稳定运行并支持手势交互
